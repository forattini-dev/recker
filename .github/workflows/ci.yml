name: CI/CD Pipeline

on:
  push:
    branches: ['main']
    tags: ['v*']
  pull_request:
    branches: ['main']

jobs:
  # 1. Quality Gate (Lint, Types, Tests)
  quality:
    name: Quality Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20, 22, 23]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint & Type Check
        run: |
          pnpm run lint
          pnpm run build # Type check via TSC

      - name: Run Tests
        run: pnpm test

  # 2. Next Release (Only on Main Push, skip version bump commits)
  release-next:
    name: Release Next
    needs: quality
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      !startsWith(github.event.head_commit.message, 'v') &&
      !contains(github.event.head_commit.message, 'version bump')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js (NPM Registry)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Bump Version (Next)
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          SHA=$(git rev-parse --short HEAD)
          BASE_VERSION=$(echo $CURRENT_VERSION | cut -d'-' -f1)
          NEW_VERSION="$BASE_VERSION-next.$SHA"

          echo "New version: $NEW_VERSION"
          npm version $NEW_VERSION --no-git-tag-version
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Build
        run: pnpm run build

      - name: Publish to NPM (Next)
        run: pnpm publish --tag next --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node.js (GitHub Packages)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@forattini-dev'

      - name: Publish to GitHub Packages (Next)
        run: |
          # Update package name for GitHub Packages scope
          node -e "
            const pkg = require('./package.json');
            pkg.name = '@forattini-dev/recker';
            pkg.publishConfig = { registry: 'https://npm.pkg.github.com' };
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "
          pnpm publish --tag next --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 3. Stable Release (Only on Tag Push v*)
  release-stable:
    name: Release Stable
    needs: quality
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js (NPM Registry)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Publish to NPM (Stable)
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node.js (GitHub Packages)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@forattini-dev'

      - name: Publish to GitHub Packages (Stable)
        run: |
          node -e "
            const pkg = require('./package.json');
            pkg.name = '@forattini-dev/recker';
            pkg.publishConfig = { registry: 'https://npm.pkg.github.com' };
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "
          pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${GITHUB_REF#refs/tags/}

          echo "## What's Changed" > CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md

          if [ -n "$PREV_TAG" ]; then
            echo "Changes since $PREV_TAG:" >> CHANGELOG_BODY.md
            echo "" >> CHANGELOG_BODY.md

            # Features
            FEATURES=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --grep="^feat" 2>/dev/null || true)
            if [ -n "$FEATURES" ]; then
              echo "### ðŸš€ Features" >> CHANGELOG_BODY.md
              echo "$FEATURES" >> CHANGELOG_BODY.md
              echo "" >> CHANGELOG_BODY.md
            fi

            # Fixes
            FIXES=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --grep="^fix" 2>/dev/null || true)
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes" >> CHANGELOG_BODY.md
              echo "$FIXES" >> CHANGELOG_BODY.md
              echo "" >> CHANGELOG_BODY.md
            fi

            # Docs
            DOCS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --grep="^docs" 2>/dev/null || true)
            if [ -n "$DOCS" ]; then
              echo "### ðŸ“š Documentation" >> CHANGELOG_BODY.md
              echo "$DOCS" >> CHANGELOG_BODY.md
              echo "" >> CHANGELOG_BODY.md
            fi

            # Tests
            TESTS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --grep="^test" 2>/dev/null || true)
            if [ -n "$TESTS" ]; then
              echo "### âœ… Tests" >> CHANGELOG_BODY.md
              echo "$TESTS" >> CHANGELOG_BODY.md
              echo "" >> CHANGELOG_BODY.md
            fi

            # CI/Chore
            CHORE=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --grep="^ci\|^chore" 2>/dev/null || true)
            if [ -n "$CHORE" ]; then
              echo "### ðŸ”§ Maintenance" >> CHANGELOG_BODY.md
              echo "$CHORE" >> CHANGELOG_BODY.md
              echo "" >> CHANGELOG_BODY.md
            fi

            # Contributors (using GitHub API to get correct usernames)
            echo "### ðŸ‘¥ Contributors" >> CHANGELOG_BODY.md
            CONTRIBUTORS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/compare/$PREV_TAG...$CURRENT_TAG" \
              | jq -r '.commits[].author.login // empty' | sort -u | grep -v '^$' || true)
            if [ -n "$CONTRIBUTORS" ]; then
              echo "$CONTRIBUTORS" | while read -r user; do
                echo "- @$user" >> CHANGELOG_BODY.md
              done
            else
              # Fallback to commit author names without @
              git log $PREV_TAG..HEAD --pretty=format:"- %an" | sort -u >> CHANGELOG_BODY.md
            fi
            echo "" >> CHANGELOG_BODY.md
          else
            echo "Initial release! ðŸŽ‰" >> CHANGELOG_BODY.md
          fi

          echo "" >> CHANGELOG_BODY.md
          echo "---" >> CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...$CURRENT_TAG" >> CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md
          echo "## ðŸ“¦ Installation" >> CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md
          echo "\`\`\`bash" >> CHANGELOG_BODY.md
          echo "# NPM" >> CHANGELOG_BODY.md
          echo "npm install recker@$CURRENT_TAG" >> CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md
          echo "# PNPM" >> CHANGELOG_BODY.md
          echo "pnpm add recker@$CURRENT_TAG" >> CHANGELOG_BODY.md
          echo "" >> CHANGELOG_BODY.md
          echo "# GitHub Packages" >> CHANGELOG_BODY.md
          echo "npm install @forattini-dev/recker@$CURRENT_TAG --registry=https://npm.pkg.github.com" >> CHANGELOG_BODY.md
          echo "\`\`\`" >> CHANGELOG_BODY.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: CHANGELOG_BODY.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
